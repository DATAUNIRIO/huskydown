# Build on OSX

language: r
cache: packages

warnings_are_errors: false

env:
  global:
  - REPO=$DOCKER_USER/huskydown

os:
  - osx
  - linux
  
pandoc_version: 1.17.2

services:
  - docker

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew tap caskroom/fonts          ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install graphviz; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew cask install font-eb-garamond font-source-code-pro font-lato          ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo tlmgr install biblatex titling titlesec quotchap lettrine appendix units tocloft draftwatermark everypage wasysym logreq xstring collection-fontsrecommended texliveonfly 
; fi
   - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker build -t $REPO . ; fi

  
after_script:
  # remove pre-built PDF,
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then R -e "unlink('index', recursive = TRUE)"  ; fi
  # make a PhD thesis from the template
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then R -e "rmarkdown::draft('index.Rmd', template = 'thesis', package = 'huskydown', create_dir = TRUE, edit = FALSE)" : fi
  #  render new thesis into a PDF
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then R -e "setwd('index'); bookdown::render_book('index.Rmd', huskydown::thesis_pdf(latex_engine = 'xelatex'))" ; fi
  #  check that we got a PDF
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then R -e "file.exists('index/_book/thesis.pdf')" ; fi
  
after_success:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  export REPO=$DOCKER_USER/huskydown ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  docker build -f Dockerfile -t $REPO:$COMMIT . ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  docker tag $REPO:$COMMIT $REPO:$TAG ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  docker tag $REPO:$COMMIT $REPO:travis-$TRAVIS_BUILD_NUMBER ; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then  docker push $REPO ; fi

